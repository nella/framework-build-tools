<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8" /><link rel="stylesheet" type="text/css" href="../../../style.css" media="all" /></head><body><pre>
<span class="line">  1: </span><span class="java-comment">/*
</span><span class="line">  2: </span><span class="java-comment"> * Licensed to Elastic Search and Shay Banon under one
</span><span class="line">  3: </span><span class="java-comment"> * or more contributor license agreements.  See the NOTICE file
</span><span class="line">  4: </span><span class="java-comment"> * distributed with this work for additional information
</span><span class="line">  5: </span><span class="java-comment"> * regarding copyright ownership. Elastic Search licenses this
</span><span class="line">  6: </span><span class="java-comment"> * file to you under the Apache License, Version 2.0 (the
</span><span class="line">  7: </span><span class="java-comment"> * &quot;License&quot;); you may not use this file except in compliance
</span><span class="line">  8: </span><span class="java-comment"> * with the License.  You may obtain a copy of the License at
</span><span class="line">  9: </span><span class="java-comment"> *
</span><span class="line"> 10: </span><span class="java-comment"> *    http://www.apache.org/licenses/LICENSE-2.0
</span><span class="line"> 11: </span><span class="java-comment"> *
</span><span class="line"> 12: </span><span class="java-comment"> * Unless required by applicable law or agreed to in writing,
</span><span class="line"> 13: </span><span class="java-comment"> * software distributed under the License is distributed on an
</span><span class="line"> 14: </span><span class="java-comment"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
</span><span class="line"> 15: </span><span class="java-comment"> * KIND, either express or implied.  See the License for the
</span><span class="line"> 16: </span><span class="java-comment"> * specific language governing permissions and limitations
</span><span class="line"> 17: </span><span class="java-comment"> * under the License.
</span><span class="line"> 18: </span><span class="java-comment"> */</span>
<span class="line"> 19: </span>
<span class="line"> 20: </span><span class="java-keywords1">package</span> org.elasticsearch.search;
<span class="line"> 21: </span>
<span class="line"> 22: </span><span class="java-keywords1">import</span> org.apache.lucene.search.Filter;
<span class="line"> 23: </span><span class="java-keywords1">import</span> org.apache.lucene.search.TopDocs;
<span class="line"> 24: </span><span class="java-keywords1">import</span> org.elasticsearch.ElasticSearchException;
<span class="line"> 25: </span><span class="java-keywords1">import</span> org.elasticsearch.action.search.SearchType;
<span class="line"> 26: </span><span class="java-keywords1">import</span> org.elasticsearch.cluster.ClusterService;
<span class="line"> 27: </span><span class="java-keywords1">import</span> org.elasticsearch.common.Nullable;
<span class="line"> 28: </span><span class="java-keywords1">import</span> org.elasticsearch.common.Unicode;
<span class="line"> 29: </span><span class="java-keywords1">import</span> org.elasticsearch.common.collect.ImmutableMap;
<span class="line"> 30: </span><span class="java-keywords1">import</span> org.elasticsearch.common.component.AbstractLifecycleComponent;
<span class="line"> 31: </span><span class="java-keywords1">import</span> org.elasticsearch.common.inject.Inject;
<span class="line"> 32: </span><span class="java-keywords1">import</span> org.elasticsearch.common.settings.Settings;
<span class="line"> 33: </span><span class="java-keywords1">import</span> org.elasticsearch.common.unit.TimeValue;
<span class="line"> 34: </span><span class="java-keywords1">import</span> org.elasticsearch.common.util.concurrent.ConcurrentCollections;
<span class="line"> 35: </span><span class="java-keywords1">import</span> org.elasticsearch.common.util.concurrent.ConcurrentMapLong;
<span class="line"> 36: </span><span class="java-keywords1">import</span> org.elasticsearch.common.xcontent.XContentFactory;
<span class="line"> 37: </span><span class="java-keywords1">import</span> org.elasticsearch.common.xcontent.XContentParser;
<span class="line"> 38: </span><span class="java-keywords1">import</span> org.elasticsearch.index.Index;
<span class="line"> 39: </span><span class="java-keywords1">import</span> org.elasticsearch.index.engine.Engine;
<span class="line"> 40: </span><span class="java-keywords1">import</span> org.elasticsearch.index.search.stats.StatsGroupsParseElement;
<span class="line"> 41: </span><span class="java-keywords1">import</span> org.elasticsearch.index.service.IndexService;
<span class="line"> 42: </span><span class="java-keywords1">import</span> org.elasticsearch.index.shard.ShardId;
<span class="line"> 43: </span><span class="java-keywords1">import</span> org.elasticsearch.index.shard.service.IndexShard;
<span class="line"> 44: </span><span class="java-keywords1">import</span> org.elasticsearch.indices.IndicesLifecycle;
<span class="line"> 45: </span><span class="java-keywords1">import</span> org.elasticsearch.indices.IndicesService;
<span class="line"> 46: </span><span class="java-keywords1">import</span> org.elasticsearch.script.ScriptService;
<span class="line"> 47: </span><span class="java-keywords1">import</span> org.elasticsearch.search.dfs.CachedDfSource;
<span class="line"> 48: </span><span class="java-keywords1">import</span> org.elasticsearch.search.dfs.DfsPhase;
<span class="line"> 49: </span><span class="java-keywords1">import</span> org.elasticsearch.search.dfs.DfsSearchResult;
<span class="line"> 50: </span><span class="java-keywords1">import</span> org.elasticsearch.search.fetch.FetchPhase;
<span class="line"> 51: </span><span class="java-keywords1">import</span> org.elasticsearch.search.fetch.FetchSearchRequest;
<span class="line"> 52: </span><span class="java-keywords1">import</span> org.elasticsearch.search.fetch.FetchSearchResult;
<span class="line"> 53: </span><span class="java-keywords1">import</span> org.elasticsearch.search.fetch.QueryFetchSearchResult;
<span class="line"> 54: </span><span class="java-keywords1">import</span> org.elasticsearch.search.fetch.ScrollQueryFetchSearchResult;
<span class="line"> 55: </span><span class="java-keywords1">import</span> org.elasticsearch.search.internal.InternalScrollSearchRequest;
<span class="line"> 56: </span><span class="java-keywords1">import</span> org.elasticsearch.search.internal.InternalSearchRequest;
<span class="line"> 57: </span><span class="java-keywords1">import</span> org.elasticsearch.search.internal.SearchContext;
<span class="line"> 58: </span><span class="java-keywords1">import</span> org.elasticsearch.search.query.QueryPhase;
<span class="line"> 59: </span><span class="java-keywords1">import</span> org.elasticsearch.search.query.QueryPhaseExecutionException;
<span class="line"> 60: </span><span class="java-keywords1">import</span> org.elasticsearch.search.query.QuerySearchRequest;
<span class="line"> 61: </span><span class="java-keywords1">import</span> org.elasticsearch.search.query.QuerySearchResult;
<span class="line"> 62: </span><span class="java-keywords1">import</span> org.elasticsearch.search.query.ScrollQuerySearchResult;
<span class="line"> 63: </span><span class="java-keywords1">import</span> org.elasticsearch.threadpool.ThreadPool;
<span class="line"> 64: </span>
<span class="line"> 65: </span><span class="java-keywords1">import</span> java.io.IOException;
<span class="line"> 66: </span><span class="java-keywords1">import</span> java.util.HashMap;
<span class="line"> 67: </span><span class="java-keywords1">import</span> java.util.Map;
<span class="line"> 68: </span><span class="java-keywords1">import</span> java.util.concurrent.ScheduledFuture;
<span class="line"> 69: </span><span class="java-keywords1">import</span> java.util.concurrent.atomic.AtomicLong;
<span class="line"> 70: </span>
<span class="line"> 71: </span><span class="java-keywords1">import</span> <span class="java-keywords1">static</span> org.elasticsearch.common.unit.TimeValue.*;
<span class="line"> 72: </span>
<span class="line"> 73: </span><span class="java-comment">/**
</span><span class="line"> 74: </span><span class="java-comment"> * @author kimchy (shay.banon)
</span><span class="line"> 75: </span><span class="java-comment"> */</span>
<span class="line"> 76: </span><span class="java-keywords1">public</span> <span class="java-keywords1">class</span> SearchService <span class="java-keywords1">extends</span> AbstractLifecycleComponent&lt;SearchService&gt; {
<span class="line"> 77: </span>
<span class="line"> 78: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> ThreadPool threadPool;
<span class="line"> 79: </span>
<span class="line"> 80: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> ClusterService clusterService;
<span class="line"> 81: </span>
<span class="line"> 82: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> IndicesService indicesService;
<span class="line"> 83: </span>
<span class="line"> 84: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> ScriptService scriptService;
<span class="line"> 85: </span>
<span class="line"> 86: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> DfsPhase dfsPhase;
<span class="line"> 87: </span>
<span class="line"> 88: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> QueryPhase queryPhase;
<span class="line"> 89: </span>
<span class="line"> 90: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> FetchPhase fetchPhase;
<span class="line"> 91: </span>
<span class="line"> 92: </span>
<span class="line"> 93: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> <span class="java-keywords1">long</span> defaultKeepAlive;
<span class="line"> 94: </span>
<span class="line"> 95: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> ScheduledFuture keepAliveReaper;
<span class="line"> 96: </span>
<span class="line"> 97: </span>
<span class="line"> 98: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> AtomicLong idGenerator = <span class="java-keywords1">new</span> AtomicLong();
<span class="line"> 99: </span>
<span class="line">100: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> CleanContextOnIndicesLifecycleListener indicesLifecycleListener = <span class="java-keywords1">new</span> CleanContextOnIndicesLifecycleListener();
<span class="line">101: </span>
<span class="line">102: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> ConcurrentMapLong&lt;SearchContext&gt; activeContexts = ConcurrentCollections.newConcurrentMapLong();
<span class="line">103: </span>
<span class="line">104: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">final</span> ImmutableMap&lt;String, SearchParseElement&gt; elementParsers;
<span class="line">105: </span>
<span class="line">106: </span>    @Inject <span class="java-keywords1">public</span> SearchService(Settings settings, ClusterService clusterService, IndicesService indicesService, IndicesLifecycle indicesLifecycle, ThreadPool threadPool,
<span class="line">107: </span>                                 ScriptService scriptService, DfsPhase dfsPhase, QueryPhase queryPhase, FetchPhase fetchPhase) {
<span class="line">108: </span>        <span class="java-keywords1">super</span>(settings);
<span class="line">109: </span>        <span class="java-keywords1">this</span>.threadPool = threadPool;
<span class="line">110: </span>        <span class="java-keywords1">this</span>.clusterService = clusterService;
<span class="line">111: </span>        <span class="java-keywords1">this</span>.indicesService = indicesService;
<span class="line">112: </span>        <span class="java-keywords1">this</span>.scriptService = scriptService;
<span class="line">113: </span>        <span class="java-keywords1">this</span>.dfsPhase = dfsPhase;
<span class="line">114: </span>        <span class="java-keywords1">this</span>.queryPhase = queryPhase;
<span class="line">115: </span>        <span class="java-keywords1">this</span>.fetchPhase = fetchPhase;
<span class="line">116: </span>
<span class="line">117: </span>        TimeValue keepAliveInterval = componentSettings.getAsTime(<span class="java-quote">&quot;keep_alive_interval&quot;</span>, timeValueMinutes(<span class="java-num">1</span>));
<span class="line">118: </span>        <span class="java-comment">// we can have 5 minutes here, since we make sure to clean with search requests and when shard/index closes</span>
<span class="line">119: </span>        <span class="java-keywords1">this</span>.defaultKeepAlive = componentSettings.getAsTime(<span class="java-quote">&quot;default_keep_alive&quot;</span>, timeValueMinutes(<span class="java-num">5</span>)).millis();
<span class="line">120: </span>
<span class="line">121: </span>        Map&lt;String, SearchParseElement&gt; elementParsers = <span class="java-keywords1">new</span> HashMap&lt;String, SearchParseElement&gt;();
<span class="line">122: </span>        elementParsers.putAll(dfsPhase.parseElements());
<span class="line">123: </span>        elementParsers.putAll(queryPhase.parseElements());
<span class="line">124: </span>        elementParsers.putAll(fetchPhase.parseElements());
<span class="line">125: </span>        elementParsers.put(<span class="java-quote">&quot;stats&quot;</span>, <span class="java-keywords1">new</span> StatsGroupsParseElement());
<span class="line">126: </span>        <span class="java-keywords1">this</span>.elementParsers = ImmutableMap.copyOf(elementParsers);
<span class="line">127: </span>        indicesLifecycle.addListener(indicesLifecycleListener);
<span class="line">128: </span>
<span class="line">129: </span>        <span class="java-keywords1">this</span>.keepAliveReaper = threadPool.scheduleWithFixedDelay(<span class="java-keywords1">new</span> Reaper(), keepAliveInterval);
<span class="line">130: </span>    }
<span class="line">131: </span>
<span class="line">132: </span>    @Override <span class="java-keywords1">protected</span> <span class="java-keywords1">void</span> doStart() <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">133: </span>    }
<span class="line">134: </span>
<span class="line">135: </span>    @Override <span class="java-keywords1">protected</span> <span class="java-keywords1">void</span> doStop() <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">136: </span>        <span class="java-keywords1">for</span> (SearchContext context : activeContexts.values()) {
<span class="line">137: </span>            freeContext(context);
<span class="line">138: </span>        }
<span class="line">139: </span>        activeContexts.clear();
<span class="line">140: </span>    }
<span class="line">141: </span>
<span class="line">142: </span>    @Override <span class="java-keywords1">protected</span> <span class="java-keywords1">void</span> doClose() <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">143: </span>        keepAliveReaper.cancel(false);
<span class="line">144: </span>        indicesService.indicesLifecycle().removeListener(indicesLifecycleListener);
<span class="line">145: </span>    }
<span class="line">146: </span>
<span class="line">147: </span>    <span class="java-keywords1">public</span> <span class="java-keywords1">void</span> releaseContextsForIndex(Index index) {
<span class="line">148: </span>        <span class="java-keywords1">for</span> (SearchContext context : activeContexts.values()) {
<span class="line">149: </span>            <span class="java-keywords1">if</span> (context.shardTarget().index().equals(index.name())) {
<span class="line">150: </span>                freeContext(context);
<span class="line">151: </span>            }
<span class="line">152: </span>        }
<span class="line">153: </span>    }
<span class="line">154: </span>
<span class="line">155: </span>    <span class="java-keywords1">public</span> <span class="java-keywords1">void</span> releaseContextsForShard(ShardId shardId) {
<span class="line">156: </span>        <span class="java-keywords1">for</span> (SearchContext context : activeContexts.values()) {
<span class="line">157: </span>            <span class="java-keywords1">if</span> (context.shardTarget().index().equals(shardId.index().name()) &amp;&amp; context.shardTarget().shardId() == shardId.id()) {
<span class="line">158: </span>                freeContext(context);
<span class="line">159: </span>            }
<span class="line">160: </span>        }
<span class="line">161: </span>    }
<span class="line">162: </span>
<span class="line">163: </span>    <span class="java-keywords1">public</span> DfsSearchResult executeDfsPhase(InternalSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">164: </span>        SearchContext context = createContext(request);
<span class="line">165: </span>        activeContexts.put(context.id(), context);
<span class="line">166: </span>        <span class="java-keywords1">try</span> {
<span class="line">167: </span>            contextProcessing(context);
<span class="line">168: </span>            dfsPhase.execute(context);
<span class="line">169: </span>            contextProcessedSuccessfully(context);
<span class="line">170: </span>            <span class="java-keywords1">return</span> context.dfsResult();
<span class="line">171: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">172: </span>            logger.trace(<span class="java-quote">&quot;Dfs phase failed&quot;</span>, e);
<span class="line">173: </span>            freeContext(context);
<span class="line">174: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">175: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">176: </span>            cleanContext(context);
<span class="line">177: </span>        }
<span class="line">178: </span>    }
<span class="line">179: </span>
<span class="line">180: </span>    <span class="java-keywords1">public</span> QuerySearchResult executeScan(InternalSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">181: </span>        SearchContext context = createContext(request);
<span class="line">182: </span>        assert context.searchType() == SearchType.SCAN;
<span class="line">183: </span>        context.searchType(SearchType.COUNT); <span class="java-comment">// move to COUNT, and then, when scrolling, move to SCAN</span>
<span class="line">184: </span>        activeContexts.put(context.id(), context);
<span class="line">185: </span>        assert context.searchType() == SearchType.COUNT;
<span class="line">186: </span>        <span class="java-keywords1">try</span> {
<span class="line">187: </span>            <span class="java-keywords1">if</span> (context.scroll() == null) {
<span class="line">188: </span>                <span class="java-keywords1">throw</span> <span class="java-keywords1">new</span> ElasticSearchException(<span class="java-quote">&quot;Scroll must be provided when scanning...&quot;</span>);
<span class="line">189: </span>            }
<span class="line">190: </span>            contextProcessing(context);
<span class="line">191: </span>            queryPhase.execute(context);
<span class="line">192: </span>            contextProcessedSuccessfully(context);
<span class="line">193: </span>            <span class="java-keywords1">return</span> context.queryResult();
<span class="line">194: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">195: </span>            logger.trace(<span class="java-quote">&quot;Scan phase failed&quot;</span>, e);
<span class="line">196: </span>            freeContext(context);
<span class="line">197: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">198: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">199: </span>            cleanContext(context);
<span class="line">200: </span>        }
<span class="line">201: </span>    }
<span class="line">202: </span>
<span class="line">203: </span>    <span class="java-keywords1">public</span> ScrollQueryFetchSearchResult executeScan(InternalScrollSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">204: </span>        SearchContext context = findContext(request.id());
<span class="line">205: </span>        contextProcessing(context);
<span class="line">206: </span>        <span class="java-keywords1">try</span> {
<span class="line">207: </span>            processScroll(request, context);
<span class="line">208: </span>            <span class="java-keywords1">if</span> (context.searchType() == SearchType.COUNT) {
<span class="line">209: </span>                <span class="java-comment">// first scanning, reset the from to 0</span>
<span class="line">210: </span>                context.searchType(SearchType.SCAN);
<span class="line">211: </span>                context.from(<span class="java-num">0</span>);
<span class="line">212: </span>            }
<span class="line">213: </span>            queryPhase.execute(context);
<span class="line">214: </span>            shortcutDocIdsToLoadForScanning(context);
<span class="line">215: </span>            fetchPhase.execute(context);
<span class="line">216: </span>            <span class="java-keywords1">if</span> (context.scroll() == null || context.fetchResult().hits().hits().length &lt; context.size()) {
<span class="line">217: </span>                freeContext(request.id());
<span class="line">218: </span>            } <span class="java-keywords1">else</span> {
<span class="line">219: </span>                contextProcessedSuccessfully(context);
<span class="line">220: </span>            }
<span class="line">221: </span>            <span class="java-keywords1">return</span> <span class="java-keywords1">new</span> ScrollQueryFetchSearchResult(<span class="java-keywords1">new</span> QueryFetchSearchResult(context.queryResult(), context.fetchResult()), context.shardTarget());
<span class="line">222: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">223: </span>            logger.trace(<span class="java-quote">&quot;Scan phase failed&quot;</span>, e);
<span class="line">224: </span>            freeContext(context);
<span class="line">225: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">226: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">227: </span>            cleanContext(context);
<span class="line">228: </span>        }
<span class="line">229: </span>    }
<span class="line">230: </span>
<span class="line">231: </span>    <span class="java-keywords1">public</span> QuerySearchResult executeQueryPhase(InternalSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">232: </span>        SearchContext context = createContext(request);
<span class="line">233: </span>        activeContexts.put(context.id(), context);
<span class="line">234: </span>        <span class="java-keywords1">try</span> {
<span class="line">235: </span>            <span class="java-keywords1">long</span> time = System.nanoTime();
<span class="line">236: </span>            contextProcessing(context);
<span class="line">237: </span>            queryPhase.execute(context);
<span class="line">238: </span>            <span class="java-keywords1">if</span> (context.searchType() == SearchType.COUNT) {
<span class="line">239: </span>                freeContext(context.id());
<span class="line">240: </span>            } <span class="java-keywords1">else</span> {
<span class="line">241: </span>                contextProcessedSuccessfully(context);
<span class="line">242: </span>            }
<span class="line">243: </span>            context.indexShard().searchService().onQueryPhase(context, System.nanoTime() - time);
<span class="line">244: </span>            <span class="java-keywords1">return</span> context.queryResult();
<span class="line">245: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">246: </span>            logger.trace(<span class="java-quote">&quot;Query phase failed&quot;</span>, e);
<span class="line">247: </span>            freeContext(context);
<span class="line">248: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">249: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">250: </span>            cleanContext(context);
<span class="line">251: </span>        }
<span class="line">252: </span>    }
<span class="line">253: </span>
<span class="line">254: </span>    <span class="java-keywords1">public</span> ScrollQuerySearchResult executeQueryPhase(InternalScrollSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">255: </span>        SearchContext context = findContext(request.id());
<span class="line">256: </span>        <span class="java-keywords1">try</span> {
<span class="line">257: </span>            <span class="java-keywords1">long</span> time = System.nanoTime();
<span class="line">258: </span>            contextProcessing(context);
<span class="line">259: </span>            processScroll(request, context);
<span class="line">260: </span>            queryPhase.execute(context);
<span class="line">261: </span>            contextProcessedSuccessfully(context);
<span class="line">262: </span>            context.indexShard().searchService().onQueryPhase(context, System.nanoTime() - time);
<span class="line">263: </span>            <span class="java-keywords1">return</span> <span class="java-keywords1">new</span> ScrollQuerySearchResult(context.queryResult(), context.shardTarget());
<span class="line">264: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">265: </span>            logger.trace(<span class="java-quote">&quot;Query phase failed&quot;</span>, e);
<span class="line">266: </span>            freeContext(context);
<span class="line">267: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">268: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">269: </span>            cleanContext(context);
<span class="line">270: </span>        }
<span class="line">271: </span>    }
<span class="line">272: </span>
<span class="line">273: </span>    <span class="java-keywords1">public</span> QuerySearchResult executeQueryPhase(QuerySearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">274: </span>        SearchContext context = findContext(request.id());
<span class="line">275: </span>        contextProcessing(context);
<span class="line">276: </span>        <span class="java-keywords1">try</span> {
<span class="line">277: </span>            context.searcher().dfSource(<span class="java-keywords1">new</span> CachedDfSource(request.dfs(), context.similarityService().defaultSearchSimilarity()));
<span class="line">278: </span>        } <span class="java-keywords1">catch</span> (IOException e) {
<span class="line">279: </span>            freeContext(context);
<span class="line">280: </span>            cleanContext(context);
<span class="line">281: </span>            <span class="java-keywords1">throw</span> <span class="java-keywords1">new</span> QueryPhaseExecutionException(context, <span class="java-quote">&quot;Failed to set aggregated df&quot;</span>, e);
<span class="line">282: </span>        }
<span class="line">283: </span>        <span class="java-keywords1">try</span> {
<span class="line">284: </span>            <span class="java-keywords1">long</span> time = System.nanoTime();
<span class="line">285: </span>            queryPhase.execute(context);
<span class="line">286: </span>            contextProcessedSuccessfully(context);
<span class="line">287: </span>            context.indexShard().searchService().onQueryPhase(context, System.nanoTime() - time);
<span class="line">288: </span>            <span class="java-keywords1">return</span> context.queryResult();
<span class="line">289: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">290: </span>            logger.trace(<span class="java-quote">&quot;Query phase failed&quot;</span>, e);
<span class="line">291: </span>            freeContext(context);
<span class="line">292: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">293: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">294: </span>            cleanContext(context);
<span class="line">295: </span>        }
<span class="line">296: </span>    }
<span class="line">297: </span>
<span class="line">298: </span>    <span class="java-keywords1">public</span> QueryFetchSearchResult executeFetchPhase(InternalSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">299: </span>        SearchContext context = createContext(request);
<span class="line">300: </span>        activeContexts.put(context.id(), context);
<span class="line">301: </span>        contextProcessing(context);
<span class="line">302: </span>        <span class="java-keywords1">try</span> {
<span class="line">303: </span>            <span class="java-keywords1">long</span> time = System.nanoTime();
<span class="line">304: </span>            queryPhase.execute(context);
<span class="line">305: </span>            <span class="java-keywords1">long</span> time2 = System.nanoTime();
<span class="line">306: </span>            context.indexShard().searchService().onQueryPhase(context, time2 - time);
<span class="line">307: </span>            shortcutDocIdsToLoad(context);
<span class="line">308: </span>            fetchPhase.execute(context);
<span class="line">309: </span>            <span class="java-keywords1">if</span> (context.scroll() == null) {
<span class="line">310: </span>                freeContext(context.id());
<span class="line">311: </span>            } <span class="java-keywords1">else</span> {
<span class="line">312: </span>                contextProcessedSuccessfully(context);
<span class="line">313: </span>            }
<span class="line">314: </span>            context.indexShard().searchService().onFetchPhase(context, System.nanoTime() - time2);
<span class="line">315: </span>            <span class="java-keywords1">return</span> <span class="java-keywords1">new</span> QueryFetchSearchResult(context.queryResult(), context.fetchResult());
<span class="line">316: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">317: </span>            logger.trace(<span class="java-quote">&quot;Fetch phase failed&quot;</span>, e);
<span class="line">318: </span>            freeContext(context);
<span class="line">319: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">320: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">321: </span>            cleanContext(context);
<span class="line">322: </span>        }
<span class="line">323: </span>    }
<span class="line">324: </span>
<span class="line">325: </span>    <span class="java-keywords1">public</span> QueryFetchSearchResult executeFetchPhase(QuerySearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">326: </span>        SearchContext context = findContext(request.id());
<span class="line">327: </span>        contextProcessing(context);
<span class="line">328: </span>        <span class="java-keywords1">try</span> {
<span class="line">329: </span>            context.searcher().dfSource(<span class="java-keywords1">new</span> CachedDfSource(request.dfs(), context.similarityService().defaultSearchSimilarity()));
<span class="line">330: </span>        } <span class="java-keywords1">catch</span> (IOException e) {
<span class="line">331: </span>            freeContext(context);
<span class="line">332: </span>            cleanContext(context);
<span class="line">333: </span>            <span class="java-keywords1">throw</span> <span class="java-keywords1">new</span> QueryPhaseExecutionException(context, <span class="java-quote">&quot;Failed to set aggregated df&quot;</span>, e);
<span class="line">334: </span>        }
<span class="line">335: </span>        <span class="java-keywords1">try</span> {
<span class="line">336: </span>            <span class="java-keywords1">long</span> time = System.nanoTime();
<span class="line">337: </span>            queryPhase.execute(context);
<span class="line">338: </span>            <span class="java-keywords1">long</span> time2 = System.nanoTime();
<span class="line">339: </span>            context.indexShard().searchService().onQueryPhase(context, time2 - time);
<span class="line">340: </span>            shortcutDocIdsToLoad(context);
<span class="line">341: </span>            fetchPhase.execute(context);
<span class="line">342: </span>            <span class="java-keywords1">if</span> (context.scroll() == null) {
<span class="line">343: </span>                freeContext(request.id());
<span class="line">344: </span>            } <span class="java-keywords1">else</span> {
<span class="line">345: </span>                contextProcessedSuccessfully(context);
<span class="line">346: </span>            }
<span class="line">347: </span>            context.indexShard().searchService().onFetchPhase(context, System.nanoTime() - time2);
<span class="line">348: </span>            <span class="java-keywords1">return</span> <span class="java-keywords1">new</span> QueryFetchSearchResult(context.queryResult(), context.fetchResult());
<span class="line">349: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">350: </span>            logger.trace(<span class="java-quote">&quot;Fetch phase failed&quot;</span>, e);
<span class="line">351: </span>            freeContext(context);
<span class="line">352: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">353: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">354: </span>            cleanContext(context);
<span class="line">355: </span>        }
<span class="line">356: </span>    }
<span class="line">357: </span>
<span class="line">358: </span>    <span class="java-keywords1">public</span> ScrollQueryFetchSearchResult executeFetchPhase(InternalScrollSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">359: </span>        SearchContext context = findContext(request.id());
<span class="line">360: </span>        contextProcessing(context);
<span class="line">361: </span>        <span class="java-keywords1">try</span> {
<span class="line">362: </span>            processScroll(request, context);
<span class="line">363: </span>            <span class="java-keywords1">long</span> time = System.nanoTime();
<span class="line">364: </span>            queryPhase.execute(context);
<span class="line">365: </span>            <span class="java-keywords1">long</span> time2 = System.nanoTime();
<span class="line">366: </span>            context.indexShard().searchService().onQueryPhase(context, time2 - time);
<span class="line">367: </span>            shortcutDocIdsToLoad(context);
<span class="line">368: </span>            fetchPhase.execute(context);
<span class="line">369: </span>            <span class="java-keywords1">if</span> (context.scroll() == null) {
<span class="line">370: </span>                freeContext(request.id());
<span class="line">371: </span>            } <span class="java-keywords1">else</span> {
<span class="line">372: </span>                contextProcessedSuccessfully(context);
<span class="line">373: </span>            }
<span class="line">374: </span>            context.indexShard().searchService().onFetchPhase(context, System.nanoTime() - time2);
<span class="line">375: </span>            <span class="java-keywords1">return</span> <span class="java-keywords1">new</span> ScrollQueryFetchSearchResult(<span class="java-keywords1">new</span> QueryFetchSearchResult(context.queryResult(), context.fetchResult()), context.shardTarget());
<span class="line">376: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">377: </span>            logger.trace(<span class="java-quote">&quot;Fetch phase failed&quot;</span>, e);
<span class="line">378: </span>            freeContext(context);
<span class="line">379: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">380: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">381: </span>            cleanContext(context);
<span class="line">382: </span>        }
<span class="line">383: </span>    }
<span class="line">384: </span>
<span class="line">385: </span>    <span class="java-keywords1">public</span> FetchSearchResult executeFetchPhase(FetchSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">386: </span>        SearchContext context = findContext(request.id());
<span class="line">387: </span>        contextProcessing(context);
<span class="line">388: </span>        <span class="java-keywords1">try</span> {
<span class="line">389: </span>            context.docIdsToLoad(request.docIds(), <span class="java-num">0</span>, request.docIdsSize());
<span class="line">390: </span>            <span class="java-keywords1">long</span> time = System.nanoTime();
<span class="line">391: </span>            fetchPhase.execute(context);
<span class="line">392: </span>            <span class="java-keywords1">if</span> (context.scroll() == null) {
<span class="line">393: </span>                freeContext(request.id());
<span class="line">394: </span>            } <span class="java-keywords1">else</span> {
<span class="line">395: </span>                contextProcessedSuccessfully(context);
<span class="line">396: </span>            }
<span class="line">397: </span>            context.indexShard().searchService().onFetchPhase(context, System.nanoTime() - time);
<span class="line">398: </span>            <span class="java-keywords1">return</span> context.fetchResult();
<span class="line">399: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">400: </span>            logger.trace(<span class="java-quote">&quot;Fetch phase failed&quot;</span>, e);
<span class="line">401: </span>            freeContext(context);
<span class="line">402: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">403: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">404: </span>            cleanContext(context);
<span class="line">405: </span>        }
<span class="line">406: </span>    }
<span class="line">407: </span>
<span class="line">408: </span>    <span class="java-keywords1">private</span> SearchContext findContext(<span class="java-keywords1">long</span> id) <span class="java-keywords1">throws</span> SearchContextMissingException {
<span class="line">409: </span>        SearchContext context = activeContexts.get(id);
<span class="line">410: </span>        <span class="java-keywords1">if</span> (context == null) {
<span class="line">411: </span>            <span class="java-keywords1">throw</span> <span class="java-keywords1">new</span> SearchContextMissingException(id);
<span class="line">412: </span>        }
<span class="line">413: </span>        SearchContext.setCurrent(context);
<span class="line">414: </span>        <span class="java-keywords1">return</span> context;
<span class="line">415: </span>    }
<span class="line">416: </span>
<span class="line">417: </span>    <span class="java-keywords1">private</span> SearchContext createContext(InternalSearchRequest request) <span class="java-keywords1">throws</span> ElasticSearchException {
<span class="line">418: </span>        IndexService indexService = indicesService.indexServiceSafe(request.index());
<span class="line">419: </span>        IndexShard indexShard = indexService.shardSafe(request.shardId());
<span class="line">420: </span>
<span class="line">421: </span>        SearchShardTarget shardTarget = <span class="java-keywords1">new</span> SearchShardTarget(clusterService.localNode().id(), request.index(), request.shardId());
<span class="line">422: </span>
<span class="line">423: </span>        Engine.Searcher engineSearcher = indexShard.searcher();
<span class="line">424: </span>        SearchContext context = <span class="java-keywords1">new</span> SearchContext(idGenerator.incrementAndGet(), shardTarget, request.searchType(), request.numberOfShards(), request.nowInMillis(), request.timeout(), request.types(), engineSearcher, indexService, indexShard, scriptService);
<span class="line">425: </span>        SearchContext.setCurrent(context);
<span class="line">426: </span>        <span class="java-keywords1">try</span> {
<span class="line">427: </span>            context.scroll(request.scroll());
<span class="line">428: </span>
<span class="line">429: </span>            parseSource(context, request.source(), request.sourceOffset(), request.sourceLength());
<span class="line">430: </span>            parseSource(context, request.extraSource(), request.extraSourceOffset(), request.extraSourceLength());
<span class="line">431: </span>
<span class="line">432: </span>            <span class="java-comment">// if the from and size are still not set, default them</span>
<span class="line">433: </span>            <span class="java-keywords1">if</span> (context.from() == -<span class="java-num">1</span>) {
<span class="line">434: </span>                context.from(<span class="java-num">0</span>);
<span class="line">435: </span>            }
<span class="line">436: </span>            <span class="java-keywords1">if</span> (context.size() == -<span class="java-num">1</span>) {
<span class="line">437: </span>                context.size(<span class="java-num">10</span>);
<span class="line">438: </span>            }
<span class="line">439: </span>
<span class="line">440: </span>            Filter aliasFilter = indexService.aliasesService().aliasFilter(request.filteringAliases());
<span class="line">441: </span>            context.aliasFilter(aliasFilter);
<span class="line">442: </span>
<span class="line">443: </span>            <span class="java-comment">// pre process</span>
<span class="line">444: </span>            dfsPhase.preProcess(context);
<span class="line">445: </span>            queryPhase.preProcess(context);
<span class="line">446: </span>            fetchPhase.preProcess(context);
<span class="line">447: </span>
<span class="line">448: </span>            <span class="java-comment">// compute the context keep alive</span>
<span class="line">449: </span>            <span class="java-keywords1">long</span> keepAlive = defaultKeepAlive;
<span class="line">450: </span>            <span class="java-keywords1">if</span> (request.scroll() != null &amp;&amp; request.scroll().keepAlive() != null) {
<span class="line">451: </span>                keepAlive = request.scroll().keepAlive().millis();
<span class="line">452: </span>            }
<span class="line">453: </span>            context.keepAlive(keepAlive);
<span class="line">454: </span>        } <span class="java-keywords1">catch</span> (RuntimeException e) {
<span class="line">455: </span>            context.release();
<span class="line">456: </span>            <span class="java-keywords1">throw</span> e;
<span class="line">457: </span>        }
<span class="line">458: </span>
<span class="line">459: </span>        <span class="java-keywords1">return</span> context;
<span class="line">460: </span>    }
<span class="line">461: </span>
<span class="line">462: </span>    <span class="java-keywords1">public</span> <span class="java-keywords1">void</span> freeContext(<span class="java-keywords1">long</span> id) {
<span class="line">463: </span>        SearchContext context = activeContexts.remove(id);
<span class="line">464: </span>        <span class="java-keywords1">if</span> (context == null) {
<span class="line">465: </span>            <span class="java-keywords1">return</span>;
<span class="line">466: </span>        }
<span class="line">467: </span>        freeContext(context);
<span class="line">468: </span>    }
<span class="line">469: </span>
<span class="line">470: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">void</span> freeContext(SearchContext context) {
<span class="line">471: </span>        activeContexts.remove(context.id());
<span class="line">472: </span>        context.release();
<span class="line">473: </span>    }
<span class="line">474: </span>
<span class="line">475: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">void</span> contextProcessing(SearchContext context) {
<span class="line">476: </span>        <span class="java-comment">// disable timeout while executing a search</span>
<span class="line">477: </span>        context.accessed(-<span class="java-num">1</span>);
<span class="line">478: </span>    }
<span class="line">479: </span>
<span class="line">480: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">void</span> contextProcessedSuccessfully(SearchContext context) {
<span class="line">481: </span>        context.accessed(threadPool.estimatedTimeInMillis());
<span class="line">482: </span>    }
<span class="line">483: </span>
<span class="line">484: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">void</span> cleanContext(SearchContext context) {
<span class="line">485: </span>        SearchContext.removeCurrent();
<span class="line">486: </span>    }
<span class="line">487: </span>
<span class="line">488: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">void</span> parseSource(SearchContext context, <span class="java-keywords1">byte</span>[] source, <span class="java-keywords1">int</span> offset, <span class="java-keywords1">int</span> length) <span class="java-keywords1">throws</span> SearchParseException {
<span class="line">489: </span>        <span class="java-comment">// nothing to parse...</span>
<span class="line">490: </span>        <span class="java-keywords1">if</span> (source == null || length == <span class="java-num">0</span>) {
<span class="line">491: </span>            <span class="java-keywords1">return</span>;
<span class="line">492: </span>        }
<span class="line">493: </span>        XContentParser parser = null;
<span class="line">494: </span>        <span class="java-keywords1">try</span> {
<span class="line">495: </span>            parser = XContentFactory.xContent(source, offset, length).createParser(source, offset, length);
<span class="line">496: </span>            XContentParser.Token token;
<span class="line">497: </span>            <span class="java-keywords1">while</span> ((token = parser.nextToken()) != XContentParser.Token.END_OBJECT) {
<span class="line">498: </span>                <span class="java-keywords1">if</span> (token == XContentParser.Token.FIELD_NAME) {
<span class="line">499: </span>                    String fieldName = parser.currentName();
<span class="line">500: </span>                    parser.nextToken();
<span class="line">501: </span>                    SearchParseElement element = elementParsers.get(fieldName);
<span class="line">502: </span>                    <span class="java-keywords1">if</span> (element == null) {
<span class="line">503: </span>                        <span class="java-keywords1">throw</span> <span class="java-keywords1">new</span> SearchParseException(context, <span class="java-quote">&quot;No parser for element [&quot;</span> + fieldName + <span class="java-quote">&quot;]&quot;</span>);
<span class="line">504: </span>                    }
<span class="line">505: </span>                    element.parse(parser, context);
<span class="line">506: </span>                } <span class="java-keywords1">else</span> <span class="java-keywords1">if</span> (token == null) {
<span class="line">507: </span>                    <span class="java-keywords1">break</span>;
<span class="line">508: </span>                }
<span class="line">509: </span>            }
<span class="line">510: </span>        } <span class="java-keywords1">catch</span> (Exception e) {
<span class="line">511: </span>            String sSource = <span class="java-quote">&quot;_na_&quot;</span>;
<span class="line">512: </span>            <span class="java-keywords1">try</span> {
<span class="line">513: </span>                sSource = Unicode.fromBytes(source, offset, length);
<span class="line">514: </span>            } <span class="java-keywords1">catch</span> (Throwable e1) {
<span class="line">515: </span>                <span class="java-comment">// ignore</span>
<span class="line">516: </span>            }
<span class="line">517: </span>            <span class="java-keywords1">throw</span> <span class="java-keywords1">new</span> SearchParseException(context, <span class="java-quote">&quot;Failed to parse source [&quot;</span> + sSource + <span class="java-quote">&quot;]&quot;</span>, e);
<span class="line">518: </span>        } <span class="java-keywords1">finally</span> {
<span class="line">519: </span>            <span class="java-keywords1">if</span> (parser != null) {
<span class="line">520: </span>                parser.close();
<span class="line">521: </span>            }
<span class="line">522: </span>        }
<span class="line">523: </span>    }
<span class="line">524: </span>
<span class="line">525: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">static</span> <span class="java-keywords1">final</span> <span class="java-keywords1">int</span>[] EMPTY_DOC_IDS = <span class="java-keywords1">new</span> <span class="java-keywords1">int</span>[<span class="java-num">0</span>];
<span class="line">526: </span>
<span class="line">527: </span>    <span class="java-comment">/**
</span><span class="line">528: </span><span class="java-comment">     * Shortcut ids to load, we load only &quot;from&quot; and up to &quot;size&quot;. The phase controller
</span><span class="line">529: </span><span class="java-comment">     * handles this as well since the result is always size * shards for Q_A_F
</span><span class="line">530: </span><span class="java-comment">     */</span>
<span class="line">531: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">void</span> shortcutDocIdsToLoad(SearchContext context) {
<span class="line">532: </span>        TopDocs topDocs = context.queryResult().topDocs();
<span class="line">533: </span>        <span class="java-keywords1">if</span> (topDocs.scoreDocs.length &lt; context.from()) {
<span class="line">534: </span>            <span class="java-comment">// no more docs...</span>
<span class="line">535: </span>            context.docIdsToLoad(EMPTY_DOC_IDS, <span class="java-num">0</span>, <span class="java-num">0</span>);
<span class="line">536: </span>            <span class="java-keywords1">return</span>;
<span class="line">537: </span>        }
<span class="line">538: </span>        <span class="java-keywords1">int</span> totalSize = context.from() + context.size();
<span class="line">539: </span>        <span class="java-keywords1">int</span>[] docIdsToLoad = <span class="java-keywords1">new</span> <span class="java-keywords1">int</span>[context.size()];
<span class="line">540: </span>        <span class="java-keywords1">int</span> counter = <span class="java-num">0</span>;
<span class="line">541: </span>        <span class="java-keywords1">for</span> (<span class="java-keywords1">int</span> i = context.from(); i &lt; totalSize; i++) {
<span class="line">542: </span>            <span class="java-keywords1">if</span> (i &lt; topDocs.scoreDocs.length) {
<span class="line">543: </span>                docIdsToLoad[counter] = topDocs.scoreDocs[i].doc;
<span class="line">544: </span>            } <span class="java-keywords1">else</span> {
<span class="line">545: </span>                <span class="java-keywords1">break</span>;
<span class="line">546: </span>            }
<span class="line">547: </span>            counter++;
<span class="line">548: </span>        }
<span class="line">549: </span>        context.docIdsToLoad(docIdsToLoad, <span class="java-num">0</span>, counter);
<span class="line">550: </span>    }
<span class="line">551: </span>
<span class="line">552: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">void</span> shortcutDocIdsToLoadForScanning(SearchContext context) {
<span class="line">553: </span>        TopDocs topDocs = context.queryResult().topDocs();
<span class="line">554: </span>        <span class="java-keywords1">if</span> (topDocs.scoreDocs.length == <span class="java-num">0</span>) {
<span class="line">555: </span>            <span class="java-comment">// no more docs...</span>
<span class="line">556: </span>            context.docIdsToLoad(EMPTY_DOC_IDS, <span class="java-num">0</span>, <span class="java-num">0</span>);
<span class="line">557: </span>            <span class="java-keywords1">return</span>;
<span class="line">558: </span>        }
<span class="line">559: </span>        <span class="java-keywords1">int</span>[] docIdsToLoad = <span class="java-keywords1">new</span> <span class="java-keywords1">int</span>[topDocs.scoreDocs.length];
<span class="line">560: </span>        <span class="java-keywords1">for</span> (<span class="java-keywords1">int</span> i = <span class="java-num">0</span>; i &lt; docIdsToLoad.length; i++) {
<span class="line">561: </span>            docIdsToLoad[i] = topDocs.scoreDocs[i].doc;
<span class="line">562: </span>        }
<span class="line">563: </span>        context.docIdsToLoad(docIdsToLoad, <span class="java-num">0</span>, docIdsToLoad.length);
<span class="line">564: </span>    }
<span class="line">565: </span>
<span class="line">566: </span>    <span class="java-keywords1">private</span> <span class="java-keywords1">void</span> processScroll(InternalScrollSearchRequest request, SearchContext context) {
<span class="line">567: </span>        <span class="java-comment">// process scroll</span>
<span class="line">568: </span>        context.from(context.from() + context.size());
<span class="line">569: </span>        context.scroll(request.scroll());
<span class="line">570: </span>        <span class="java-comment">// update the context keep alive based on the new scroll value</span>
<span class="line">571: </span>        <span class="java-keywords1">if</span> (request.scroll() != null &amp;&amp; request.scroll().keepAlive() != null) {
<span class="line">572: </span>            context.keepAlive(request.scroll().keepAlive().millis());
<span class="line">573: </span>        }
<span class="line">574: </span>    }
<span class="line">575: </span>
<span class="line">576: </span>    <span class="java-keywords1">class</span> CleanContextOnIndicesLifecycleListener <span class="java-keywords1">extends</span> IndicesLifecycle.Listener {
<span class="line">577: </span>
<span class="line">578: </span>        @Override <span class="java-keywords1">public</span> <span class="java-keywords1">void</span> beforeIndexClosed(IndexService indexService, <span class="java-keywords1">boolean</span> delete) {
<span class="line">579: </span>            releaseContextsForIndex(indexService.index());
<span class="line">580: </span>        }
<span class="line">581: </span>
<span class="line">582: </span>        @Override <span class="java-keywords1">public</span> <span class="java-keywords1">void</span> beforeIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard, <span class="java-keywords1">boolean</span> delete) {
<span class="line">583: </span>            releaseContextsForShard(shardId);
<span class="line">584: </span>        }
<span class="line">585: </span>    }
<span class="line">586: </span>
<span class="line">587: </span>    <span class="java-keywords1">class</span> Reaper <span class="java-keywords1">implements</span> Runnable {
<span class="line">588: </span>        @Override <span class="java-keywords1">public</span> <span class="java-keywords1">void</span> run() {
<span class="line">589: </span>            <span class="java-keywords1">long</span> time = threadPool.estimatedTimeInMillis();
<span class="line">590: </span>            <span class="java-keywords1">for</span> (SearchContext context : activeContexts.values()) {
<span class="line">591: </span>                <span class="java-keywords1">if</span> (context.lastAccessTime() == -<span class="java-num">1</span>) { <span class="java-comment">// its being processed or timeout is disabled</span>
<span class="line">592: </span>                    <span class="java-keywords1">continue</span>;
<span class="line">593: </span>                }
<span class="line">594: </span>                <span class="java-keywords1">if</span> ((time - context.lastAccessTime() &gt; context.keepAlive())) {
<span class="line">595: </span>                    freeContext(context);
<span class="line">596: </span>                }
<span class="line">597: </span>            }
<span class="line">598: </span>        }
<span class="line">599: </span>    }
<span class="line">600: </span>}
<span class="line">601: </span>
</pre></body></html>