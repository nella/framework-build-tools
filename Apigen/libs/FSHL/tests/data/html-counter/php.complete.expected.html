<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8" /><link rel="stylesheet" type="text/css" href="../../../style.css" media="all" /></head><body><pre>
<span class="line">  1: </span><span class="xlang">&lt;?php</span>
<span class="line">  2: </span>
<span class="line">  3: </span><span class="php-comment">/**
</span><span class="line">  4: </span><span class="php-comment"> * FSHL 2.0.0                                  | Fast Syntax HighLighter |
</span><span class="line">  5: </span><span class="php-comment"> * -----------------------------------------------------------------------
</span><span class="line">  6: </span><span class="php-comment"> *
</span><span class="line">  7: </span><span class="php-comment"> * LICENSE
</span><span class="line">  8: </span><span class="php-comment"> *
</span><span class="line">  9: </span><span class="php-comment"> * This program is free software; you can redistribute it and/or modify
</span><span class="line"> 10: </span><span class="php-comment"> * it under the terms of the GNU General Public License as published by
</span><span class="line"> 11: </span><span class="php-comment"> * the Free Software Foundation; either version 2 of the License, or
</span><span class="line"> 12: </span><span class="php-comment"> * (at your option) any later version.
</span><span class="line"> 13: </span><span class="php-comment"> *
</span><span class="line"> 14: </span><span class="php-comment"> * This program is distributed in the hope that it will be useful,
</span><span class="line"> 15: </span><span class="php-comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><span class="line"> 16: </span><span class="php-comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
</span><span class="line"> 17: </span><span class="php-comment"> * GNU General Public License for more details.
</span><span class="line"> 18: </span><span class="php-comment"> */</span>
<span class="line"> 19: </span>
<span class="line"> 20: </span><span class="php-keyword1">namespace</span> FSHL;
<span class="line"> 21: </span>
<span class="line"> 22: </span><span class="php-comment">/**
</span><span class="line"> 23: </span><span class="php-comment"> * Highlighter.
</span><span class="line"> 24: </span><span class="php-comment"> *
</span><span class="line"> 25: </span><span class="php-comment"> * @copyright Copyright (c) 2002-2005 Juraj 'hvge' Durech
</span><span class="line"> 26: </span><span class="php-comment"> * @copyright Copyright (c) 2011 Jaroslav Hansl√≠k
</span><span class="line"> 27: </span><span class="php-comment"> * @license http://fshl.kukulich.cz/#license
</span><span class="line"> 28: </span><span class="php-comment"> */</span>
<span class="line"> 29: </span><span class="php-keyword1">class</span> Highlighter
<span class="line"> 30: </span>{
<span class="line"> 31: </span>    <span class="php-comment">/**
</span><span class="line"> 32: </span><span class="php-comment">     * No options.
</span><span class="line"> 33: </span><span class="php-comment">     *
</span><span class="line"> 34: </span><span class="php-comment">     * @var integer
</span><span class="line"> 35: </span><span class="php-comment">     */</span>
<span class="line"> 36: </span>    <span class="php-keyword1">const</span> OPTION_DEFAULT = <span class="php-num">0x0000</span>;
<span class="line"> 37: </span>
<span class="line"> 38: </span>    <span class="php-comment">/**
</span><span class="line"> 39: </span><span class="php-comment">     * Tab indentation option.
</span><span class="line"> 40: </span><span class="php-comment">     *
</span><span class="line"> 41: </span><span class="php-comment">     * @var integer
</span><span class="line"> 42: </span><span class="php-comment">     */</span>
<span class="line"> 43: </span>    <span class="php-keyword1">const</span> OPTION_TAB_INDENT = <span class="php-num">0x0010</span>;
<span class="line"> 44: </span>
<span class="line"> 45: </span>    <span class="php-comment">/**
</span><span class="line"> 46: </span><span class="php-comment">     * Line counter option.
</span><span class="line"> 47: </span><span class="php-comment">     *
</span><span class="line"> 48: </span><span class="php-comment">     * @var integer
</span><span class="line"> 49: </span><span class="php-comment">     */</span>
<span class="line"> 50: </span>    <span class="php-keyword1">const</span> OPTION_LINE_COUNTER = <span class="php-num">0x0020</span>;
<span class="line"> 51: </span>
<span class="line"> 52: </span>    <span class="php-comment">/**
</span><span class="line"> 53: </span><span class="php-comment">     * Output mode.
</span><span class="line"> 54: </span><span class="php-comment">     *
</span><span class="line"> 55: </span><span class="php-comment">     * @var \FSHL\Output
</span><span class="line"> 56: </span><span class="php-comment">     */</span>
<span class="line"> 57: </span>    <span class="php-keyword1">private</span> <span class="php-var">$output</span> = <span class="php-keyword1">null</span>;
<span class="line"> 58: </span>
<span class="line"> 59: </span>    <span class="php-comment">/**
</span><span class="line"> 60: </span><span class="php-comment">     * Options.
</span><span class="line"> 61: </span><span class="php-comment">     *
</span><span class="line"> 62: </span><span class="php-comment">     * @var integer
</span><span class="line"> 63: </span><span class="php-comment">     */</span>
<span class="line"> 64: </span>    <span class="php-keyword1">private</span> <span class="php-var">$options</span>;
<span class="line"> 65: </span>
<span class="line"> 66: </span>    <span class="php-comment">/**
</span><span class="line"> 67: </span><span class="php-comment">     * Tab indent width.
</span><span class="line"> 68: </span><span class="php-comment">     *
</span><span class="line"> 69: </span><span class="php-comment">     * @var integer
</span><span class="line"> 70: </span><span class="php-comment">     */</span>
<span class="line"> 71: </span>    <span class="php-keyword1">private</span> <span class="php-var">$tabIndentWidth</span>;
<span class="line"> 72: </span>
<span class="line"> 73: </span>    <span class="php-comment">/**
</span><span class="line"> 74: </span><span class="php-comment">     * List of already used lexers.
</span><span class="line"> 75: </span><span class="php-comment">     *
</span><span class="line"> 76: </span><span class="php-comment">     * @var array
</span><span class="line"> 77: </span><span class="php-comment">     */</span>
<span class="line"> 78: </span>    <span class="php-keyword1">private</span> <span class="php-var">$lexers</span> = <span class="php-keyword1">array</span>();
<span class="line"> 79: </span>
<span class="line"> 80: </span>    <span class="php-comment">/**
</span><span class="line"> 81: </span><span class="php-comment">     * Current lexer.
</span><span class="line"> 82: </span><span class="php-comment">     *
</span><span class="line"> 83: </span><span class="php-comment">     * @var \FSHL\Lexer
</span><span class="line"> 84: </span><span class="php-comment">     */</span>
<span class="line"> 85: </span>    <span class="php-keyword1">private</span> <span class="php-var">$lexer</span> = <span class="php-keyword1">null</span>;
<span class="line"> 86: </span>
<span class="line"> 87: </span>    <span class="php-comment">/**
</span><span class="line"> 88: </span><span class="php-comment">     * Table for tab indentation.
</span><span class="line"> 89: </span><span class="php-comment">     *
</span><span class="line"> 90: </span><span class="php-comment">     * @var array
</span><span class="line"> 91: </span><span class="php-comment">     */</span>
<span class="line"> 92: </span>    <span class="php-keyword1">private</span> <span class="php-var">$tabs</span> = <span class="php-keyword1">array</span>();
<span class="line"> 93: </span>
<span class="line"> 94: </span>    <span class="php-comment">/**
</span><span class="line"> 95: </span><span class="php-comment">     * States stack.
</span><span class="line"> 96: </span><span class="php-comment">     *
</span><span class="line"> 97: </span><span class="php-comment">     * @var array
</span><span class="line"> 98: </span><span class="php-comment">     */</span>
<span class="line"> 99: </span>    <span class="php-keyword1">private</span> <span class="php-var">$stack</span> = <span class="php-keyword1">array</span>();
<span class="line">100: </span>
<span class="line">101: </span>    <span class="php-comment">/**
</span><span class="line">102: </span><span class="php-comment">     * Prepares the highlighter.
</span><span class="line">103: </span><span class="php-comment">     *
</span><span class="line">104: </span><span class="php-comment">     * @param \FSHL\Output $output
</span><span class="line">105: </span><span class="php-comment">     * @param integer $options
</span><span class="line">106: </span><span class="php-comment">     * @param integer $tabIndentWidth
</span><span class="line">107: </span><span class="php-comment">     */</span>
<span class="line">108: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> __construct(Output <span class="php-var">$output</span>, <span class="php-var">$options</span> = self::OPTION_DEFAULT, <span class="php-var">$tabIndentWidth</span> = <span class="php-num">4</span>)
<span class="line">109: </span>    {
<span class="line">110: </span>        <span class="php-var">$this</span>-&gt;setOutput(<span class="php-var">$output</span>)
<span class="line">111: </span>            -&gt;setOptions(<span class="php-var">$options</span>, <span class="php-var">$tabIndentWidth</span>);
<span class="line">112: </span>    }
<span class="line">113: </span>
<span class="line">114: </span>    <span class="php-comment">/**
</span><span class="line">115: </span><span class="php-comment">     * Highlightes a string.
</span><span class="line">116: </span><span class="php-comment">     *
</span><span class="line">117: </span><span class="php-comment">     * @param string $text
</span><span class="line">118: </span><span class="php-comment">     * @param \FSHL\Lexer $lexer
</span><span class="line">119: </span><span class="php-comment">     * @return string
</span><span class="line">120: </span><span class="php-comment">     * @throws \RuntimeException If no lexer is set.
</span><span class="line">121: </span><span class="php-comment">     */</span>
<span class="line">122: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> highlight(<span class="php-var">$text</span>, Lexer <span class="php-var">$lexer</span> = <span class="php-keyword1">null</span>)
<span class="line">123: </span>    {
<span class="line">124: </span>        <span class="php-comment">// Sets the lexer</span>
<span class="line">125: </span>        <span class="php-var">$initialLexer</span> = <span class="php-var">$this</span>-&gt;lexer;
<span class="line">126: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> !== <span class="php-var">$lexer</span>) {
<span class="line">127: </span>            <span class="php-var">$this</span>-&gt;setLexer(<span class="php-var">$lexer</span>);
<span class="line">128: </span>        }
<span class="line">129: </span>
<span class="line">130: </span>        <span class="php-comment">// No lexer</span>
<span class="line">131: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">null</span> === <span class="php-var">$this</span>-&gt;lexer) {
<span class="line">132: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \RuntimeException(<span class="php-quote">'No lexer set'</span>);
<span class="line">133: </span>        }
<span class="line">134: </span>
<span class="line">135: </span>        <span class="php-comment">// Prepares the text</span>
<span class="line">136: </span>        <span class="php-var">$text</span> = <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">&quot;\r\n&quot;</span>, <span class="php-quote">&quot;\r&quot;</span>), <span class="php-quote">&quot;\n&quot;</span>, (string) <span class="php-var">$text</span>);
<span class="line">137: </span>        <span class="php-var">$textLength</span> = <span class="php-keyword2">strlen</span>(<span class="php-var">$text</span>);
<span class="line">138: </span>        <span class="php-var">$textPos</span> = <span class="php-num">0</span>;
<span class="line">139: </span>
<span class="line">140: </span>        <span class="php-comment">// Parses the text</span>
<span class="line">141: </span>        <span class="php-var">$output</span> = <span class="php-keyword1">array</span>();
<span class="line">142: </span>        <span class="php-var">$fragment</span> = <span class="php-quote">''</span>;
<span class="line">143: </span>        <span class="php-var">$maxLineWidth</span> = <span class="php-num">0</span>;
<span class="line">144: </span>        <span class="php-var">$line</span> = <span class="php-num">1</span>;
<span class="line">145: </span>        <span class="php-var">$char</span> = <span class="php-num">0</span>;
<span class="line">146: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;options &amp; self::OPTION_LINE_COUNTER) {
<span class="line">147: </span>            <span class="php-comment">// Right aligment of line counter</span>
<span class="line">148: </span>            <span class="php-var">$maxLineWidth</span> = <span class="php-keyword2">strlen</span>(<span class="php-keyword2">substr_count</span>(<span class="php-var">$text</span>, <span class="php-quote">&quot;\n&quot;</span>) + <span class="php-num">1</span>);
<span class="line">149: </span>            <span class="php-var">$fragment</span> .= <span class="php-var">$this</span>-&gt;line(<span class="php-var">$line</span>, <span class="php-var">$maxLineWidth</span>);
<span class="line">150: </span>        }
<span class="line">151: </span>        <span class="php-var">$newLexerName</span> = <span class="php-var">$lexerName</span> = <span class="php-var">$this</span>-&gt;lexer-&gt;language;
<span class="line">152: </span>        <span class="php-var">$newState</span> = <span class="php-var">$state</span> = <span class="php-var">$this</span>-&gt;lexer-&gt;initialState;
<span class="line">153: </span>        <span class="php-var">$this</span>-&gt;stack = <span class="php-keyword1">array</span>();
<span class="line">154: </span>
<span class="line">155: </span>        <span class="php-keyword1">while</span> (<span class="php-keyword1">true</span>) {
<span class="line">156: </span>            <span class="php-keyword1">list</span>(<span class="php-var">$transitionId</span>, <span class="php-var">$delimiter</span>, <span class="php-var">$buffer</span>) = <span class="php-var">$this</span>-&gt;lexer-&gt;{<span class="php-quote">'findDelimiter'</span> . <span class="php-var">$state</span>}(<span class="php-var">$text</span>, <span class="php-var">$textLength</span>, <span class="php-var">$textPos</span>);
<span class="line">157: </span>
<span class="line">158: </span>            <span class="php-comment">// Some data may be collected before getPart reaches the delimiter, we must output this before other processing</span>
<span class="line">159: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword1">false</span> !== <span class="php-var">$buffer</span>) {
<span class="line">160: </span>                <span class="php-var">$bufferLength</span> = <span class="php-keyword2">strlen</span>(<span class="php-var">$buffer</span>);
<span class="line">161: </span>                <span class="php-var">$textPos</span> += <span class="php-var">$bufferLength</span>;
<span class="line">162: </span>                <span class="php-var">$char</span> += <span class="php-var">$bufferLength</span>;
<span class="line">163: </span>                <span class="php-var">$fragment</span> .= <span class="php-var">$this</span>-&gt;template(<span class="php-var">$buffer</span>, <span class="php-var">$state</span>);
<span class="line">164: </span>                <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$fragment</span>[<span class="php-num">8192</span>])) {
<span class="line">165: </span>                    <span class="php-var">$output</span>[] = <span class="php-var">$fragment</span>;
<span class="line">166: </span>                    <span class="php-var">$fragment</span> = <span class="php-quote">''</span>;
<span class="line">167: </span>                }
<span class="line">168: </span>            }
<span class="line">169: </span>
<span class="line">170: </span>            <span class="php-keyword1">if</span> (-<span class="php-num">1</span> === <span class="php-var">$transitionId</span>) {
<span class="line">171: </span>                <span class="php-comment">// End of stream</span>
<span class="line">172: </span>                <span class="php-keyword1">break</span>;
<span class="line">173: </span>            }
<span class="line">174: </span>
<span class="line">175: </span>            <span class="php-comment">// Processes received delimiter as string</span>
<span class="line">176: </span>            <span class="php-var">$prevLine</span> = <span class="php-var">$line</span>;
<span class="line">177: </span>            <span class="php-var">$prevChar</span> = <span class="php-var">$char</span>;
<span class="line">178: </span>            <span class="php-var">$prevTextPos</span> = <span class="php-var">$textPos</span>;
<span class="line">179: </span>
<span class="line">180: </span>            <span class="php-var">$delimiterLength</span> = <span class="php-keyword2">strlen</span>(<span class="php-var">$delimiter</span>);
<span class="line">181: </span>            <span class="php-var">$textPos</span> += <span class="php-var">$delimiterLength</span>;
<span class="line">182: </span>            <span class="php-var">$char</span> += <span class="php-var">$delimiterLength</span>;
<span class="line">183: </span>
<span class="line">184: </span>            <span class="php-comment">// Adds line counter and tab indentation</span>
<span class="line">185: </span>            <span class="php-var">$addLine</span> = <span class="php-keyword1">false</span>;
<span class="line">186: </span>            <span class="php-keyword1">if</span> (<span class="php-quote">&quot;\n&quot;</span> === <span class="php-var">$delimiter</span>[<span class="php-var">$delimiterLength</span> - <span class="php-num">1</span>]) {
<span class="line">187: </span>                <span class="php-comment">// Line counter</span>
<span class="line">188: </span>                <span class="php-var">$line</span>++;
<span class="line">189: </span>                <span class="php-var">$char</span> = <span class="php-num">0</span>;
<span class="line">190: </span>                <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;options &amp; self::OPTION_LINE_COUNTER) {
<span class="line">191: </span>                    <span class="php-var">$addLine</span> = <span class="php-keyword1">true</span>;
<span class="line">192: </span>                    <span class="php-var">$actualLine</span> = <span class="php-var">$line</span>;
<span class="line">193: </span>                }
<span class="line">194: </span>            } <span class="php-keyword1">elseif</span> (<span class="php-quote">&quot;\t&quot;</span> === <span class="php-var">$delimiter</span> &amp;&amp; (<span class="php-var">$this</span>-&gt;options &amp; self::OPTION_TAB_INDENT)) {
<span class="line">195: </span>                <span class="php-comment">// Tab indentation</span>
<span class="line">196: </span>                <span class="php-var">$i</span> = <span class="php-var">$char</span> % <span class="php-var">$this</span>-&gt;tabIndentWidth;
<span class="line">197: </span>                <span class="php-var">$delimiter</span> = <span class="php-var">$this</span>-&gt;tabs[<span class="php-var">$i</span>][<span class="php-num">0</span>];
<span class="line">198: </span>                <span class="php-var">$char</span> += <span class="php-var">$this</span>-&gt;tabs[<span class="php-var">$i</span>][<span class="php-num">1</span>];
<span class="line">199: </span>            }
<span class="line">200: </span>
<span class="line">201: </span>            <span class="php-comment">// Gets new state from the transitions table</span>
<span class="line">202: </span>            <span class="php-var">$newState</span> = <span class="php-var">$this</span>-&gt;lexer-&gt;trans[<span class="php-var">$state</span>][<span class="php-var">$transitionId</span>][Generator::STATE_DIAGRAM_INDEX_STATE];
<span class="line">203: </span>            <span class="php-keyword1">if</span> (<span class="php-var">$newState</span> === <span class="php-var">$this</span>-&gt;lexer-&gt;returnState) {
<span class="line">204: </span>                <span class="php-comment">// Chooses mode of delimiter processing</span>
<span class="line">205: </span>                <span class="php-keyword1">if</span> (Generator::BACK === <span class="php-var">$this</span>-&gt;lexer-&gt;trans[<span class="php-var">$state</span>][<span class="php-var">$transitionId</span>][Generator::STATE_DIAGRAM_INDEX_MODE]) {
<span class="line">206: </span>                    <span class="php-var">$line</span> = <span class="php-var">$prevLine</span>;
<span class="line">207: </span>                    <span class="php-var">$char</span> = <span class="php-var">$prevChar</span>;
<span class="line">208: </span>                    <span class="php-var">$textPos</span> = <span class="php-var">$prevTextPos</span>;
<span class="line">209: </span>                } <span class="php-keyword1">else</span> {
<span class="line">210: </span>                    <span class="php-var">$fragment</span> .= <span class="php-var">$this</span>-&gt;template(<span class="php-var">$delimiter</span>, <span class="php-var">$state</span>);
<span class="line">211: </span>                    <span class="php-keyword1">if</span> (<span class="php-var">$addLine</span>) {
<span class="line">212: </span>                        <span class="php-var">$fragment</span> .= <span class="php-var">$this</span>-&gt;line(<span class="php-var">$actualLine</span>, <span class="php-var">$maxLineWidth</span>);
<span class="line">213: </span>                    }
<span class="line">214: </span>                    <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$fragment</span>[<span class="php-num">8192</span>])) {
<span class="line">215: </span>                        <span class="php-var">$output</span>[] = <span class="php-var">$fragment</span>;
<span class="line">216: </span>                        <span class="php-var">$fragment</span> = <span class="php-quote">''</span>;
<span class="line">217: </span>                    }
<span class="line">218: </span>                }
<span class="line">219: </span>
<span class="line">220: </span>                <span class="php-comment">// Get state from the context stack</span>
<span class="line">221: </span>                <span class="php-keyword1">if</span> (<span class="php-var">$item</span> = <span class="php-var">$this</span>-&gt;popState()) {
<span class="line">222: </span>                    <span class="php-keyword1">list</span>(<span class="php-var">$newLexerName</span>, <span class="php-var">$state</span>) = <span class="php-var">$item</span>;
<span class="line">223: </span>                    <span class="php-comment">// If previous context was in a different lexer, switch the lexer too</span>
<span class="line">224: </span>                    <span class="php-keyword1">if</span> (<span class="php-var">$newLexerName</span> !== <span class="php-var">$lexerName</span>) {
<span class="line">225: </span>                        <span class="php-var">$this</span>-&gt;setLexerByName(<span class="php-var">$newLexerName</span>);
<span class="line">226: </span>                        <span class="php-var">$lexerName</span> = <span class="php-var">$newLexerName</span>;
<span class="line">227: </span>                    }
<span class="line">228: </span>                } <span class="php-keyword1">else</span> {
<span class="line">229: </span>                    <span class="php-var">$state</span> = <span class="php-var">$this</span>-&gt;lexer-&gt;initialState;
<span class="line">230: </span>                }
<span class="line">231: </span>
<span class="line">232: </span>                <span class="php-keyword1">continue</span>;
<span class="line">233: </span>            }
<span class="line">234: </span>
<span class="line">235: </span>            <span class="php-comment">// Chooses mode of delimiter processing</span>
<span class="line">236: </span>            <span class="php-var">$type</span> = <span class="php-var">$this</span>-&gt;lexer-&gt;trans[<span class="php-var">$state</span>][<span class="php-var">$transitionId</span>][Generator::STATE_DIAGRAM_INDEX_MODE];
<span class="line">237: </span>            <span class="php-keyword1">if</span> (Generator::BACK === <span class="php-var">$type</span>) {
<span class="line">238: </span>                <span class="php-var">$line</span> = <span class="php-var">$prevLine</span>;
<span class="line">239: </span>                <span class="php-var">$char</span> = <span class="php-var">$prevChar</span>;
<span class="line">240: </span>                <span class="php-var">$textPos</span> = <span class="php-var">$prevTextPos</span>;
<span class="line">241: </span>            } <span class="php-keyword1">else</span> {
<span class="line">242: </span>                <span class="php-var">$fragment</span> .= <span class="php-var">$this</span>-&gt;template(<span class="php-var">$delimiter</span>, Generator::<span class="php-keyword2">NEXT</span> === <span class="php-var">$type</span> ? <span class="php-var">$newState</span> : <span class="php-var">$state</span>);
<span class="line">243: </span>                <span class="php-keyword1">if</span> (<span class="php-var">$addLine</span>) {
<span class="line">244: </span>                    <span class="php-var">$fragment</span> .= <span class="php-var">$this</span>-&gt;line(<span class="php-var">$actualLine</span>, <span class="php-var">$maxLineWidth</span>);
<span class="line">245: </span>                }
<span class="line">246: </span>                <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$fragment</span>[<span class="php-num">8192</span>])) {
<span class="line">247: </span>                    <span class="php-var">$output</span>[] = <span class="php-var">$fragment</span>;
<span class="line">248: </span>                    <span class="php-var">$fragment</span> = <span class="php-quote">''</span>;
<span class="line">249: </span>                }
<span class="line">250: </span>            }
<span class="line">251: </span>
<span class="line">252: </span>            <span class="php-comment">// Switches between lexers (transition to embedded language)</span>
<span class="line">253: </span>            <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;lexer-&gt;flags[<span class="php-var">$newState</span>] &amp; Generator::STATE_FLAG_NEWLEXER) {
<span class="line">254: </span>                <span class="php-keyword1">if</span> (<span class="php-var">$newState</span> === <span class="php-var">$this</span>-&gt;lexer-&gt;quitState) {
<span class="line">255: </span>                    <span class="php-comment">// Returns to the previous lexer</span>
<span class="line">256: </span>                    <span class="php-keyword1">if</span> (<span class="php-var">$item</span> = <span class="php-var">$this</span>-&gt;popState()) {
<span class="line">257: </span>                        <span class="php-keyword1">list</span>(<span class="php-var">$newLexerName</span>, <span class="php-var">$state</span>) = <span class="php-var">$item</span>;
<span class="line">258: </span>                        <span class="php-keyword1">if</span> (<span class="php-var">$newLexerName</span> !== <span class="php-var">$lexerName</span>) {
<span class="line">259: </span>                            <span class="php-var">$this</span>-&gt;setLexerByName(<span class="php-var">$newLexerName</span>);
<span class="line">260: </span>                            <span class="php-var">$lexerName</span> = <span class="php-var">$newLexerName</span>;
<span class="line">261: </span>                        }
<span class="line">262: </span>                    } <span class="php-keyword1">else</span> {
<span class="line">263: </span>                        <span class="php-var">$state</span> = <span class="php-var">$this</span>-&gt;lexer-&gt;initialState;
<span class="line">264: </span>                    }
<span class="line">265: </span>                } <span class="php-keyword1">else</span> {
<span class="line">266: </span>                    <span class="php-comment">// Switches to the embedded language</span>
<span class="line">267: </span>                    <span class="php-var">$newLexerName</span> = <span class="php-var">$this</span>-&gt;lexer-&gt;data[<span class="php-var">$newState</span>];
<span class="line">268: </span>                    <span class="php-var">$this</span>-&gt;pushState(<span class="php-var">$lexerName</span>, <span class="php-var">$this</span>-&gt;lexer-&gt;trans[<span class="php-var">$newState</span>] ? <span class="php-var">$newState</span> : <span class="php-var">$state</span>);
<span class="line">269: </span>                    <span class="php-var">$this</span>-&gt;setLexerByName(<span class="php-var">$newLexerName</span>);
<span class="line">270: </span>                    <span class="php-var">$lexerName</span> = <span class="php-var">$newLexerName</span>;
<span class="line">271: </span>                    <span class="php-var">$state</span> = <span class="php-var">$this</span>-&gt;lexer-&gt;initialState;
<span class="line">272: </span>                }
<span class="line">273: </span>
<span class="line">274: </span>                <span class="php-keyword1">continue</span>;
<span class="line">275: </span>            }
<span class="line">276: </span>
<span class="line">277: </span>            <span class="php-comment">// If newState is marked with recursion flag (alias call), push current state to the context stack</span>
<span class="line">278: </span>            <span class="php-keyword1">if</span> ((<span class="php-var">$this</span>-&gt;lexer-&gt;flags[<span class="php-var">$newState</span>] &amp; Generator::STATE_FLAG_RECURSION) &amp;&amp; <span class="php-var">$state</span> !== <span class="php-var">$newState</span>) {
<span class="line">279: </span>                <span class="php-var">$this</span>-&gt;pushState(<span class="php-var">$lexerName</span>, <span class="php-var">$state</span>);
<span class="line">280: </span>            }
<span class="line">281: </span>
<span class="line">282: </span>            <span class="php-comment">// Change the state</span>
<span class="line">283: </span>            <span class="php-var">$state</span> = <span class="php-var">$newState</span>;
<span class="line">284: </span>        }
<span class="line">285: </span>
<span class="line">286: </span>        <span class="php-comment">// Adds template end</span>
<span class="line">287: </span>        <span class="php-var">$fragment</span> .= <span class="php-var">$this</span>-&gt;output-&gt;template(<span class="php-quote">''</span>, <span class="php-keyword1">null</span>);
<span class="line">288: </span>        <span class="php-var">$output</span>[] = <span class="php-var">$fragment</span>;
<span class="line">289: </span>
<span class="line">290: </span>        <span class="php-comment">// Restore lexer</span>
<span class="line">291: </span>        <span class="php-var">$this</span>-&gt;lexer = <span class="php-var">$initialLexer</span>;
<span class="line">292: </span>
<span class="line">293: </span>        <span class="php-keyword1">return</span> <span class="php-keyword2">implode</span>(<span class="php-quote">''</span>, <span class="php-var">$output</span>);
<span class="line">294: </span>    }
<span class="line">295: </span>
<span class="line">296: </span>    <span class="php-comment">/**
</span><span class="line">297: </span><span class="php-comment">     * Sets the output mode.
</span><span class="line">298: </span><span class="php-comment">     *
</span><span class="line">299: </span><span class="php-comment">     * @param \FSHL\Output $output
</span><span class="line">300: </span><span class="php-comment">     * @return \FSHL\Highlighter
</span><span class="line">301: </span><span class="php-comment">     */</span>
<span class="line">302: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setOutput(Output <span class="php-var">$output</span>)
<span class="line">303: </span>    {
<span class="line">304: </span>        <span class="php-var">$this</span>-&gt;output = <span class="php-var">$output</span>;
<span class="line">305: </span>
<span class="line">306: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
<span class="line">307: </span>    }
<span class="line">308: </span>
<span class="line">309: </span>    <span class="php-comment">/**
</span><span class="line">310: </span><span class="php-comment">     * Sets options.
</span><span class="line">311: </span><span class="php-comment">     *
</span><span class="line">312: </span><span class="php-comment">     * @param integer $options
</span><span class="line">313: </span><span class="php-comment">     * @param integer $tabIndentWidth
</span><span class="line">314: </span><span class="php-comment">     * @return \FSHL\Highlighter
</span><span class="line">315: </span><span class="php-comment">     */</span>
<span class="line">316: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setOptions(<span class="php-var">$options</span> = self::OPTION_DEFAULT, <span class="php-var">$tabIndentWidth</span> = <span class="php-num">4</span>)
<span class="line">317: </span>    {
<span class="line">318: </span>        <span class="php-var">$this</span>-&gt;options = <span class="php-var">$options</span>;
<span class="line">319: </span>
<span class="line">320: </span>        <span class="php-keyword1">if</span> ((<span class="php-var">$this</span>-&gt;options &amp; self::OPTION_TAB_INDENT) &amp;&amp; <span class="php-var">$tabIndentWidth</span> &gt; <span class="php-num">0</span>) {
<span class="line">321: </span>            <span class="php-comment">// Precalculate a table for tab indentation</span>
<span class="line">322: </span>            <span class="php-var">$t</span> = <span class="php-quote">' '</span>;
<span class="line">323: </span>            <span class="php-var">$ti</span> = <span class="php-num">0</span>;
<span class="line">324: </span>            <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-var">$tabIndentWidth</span>; <span class="php-var">$i</span>; <span class="php-var">$i</span>--) {
<span class="line">325: </span>                <span class="php-var">$this</span>-&gt;tabs[<span class="php-var">$i</span> % <span class="php-var">$tabIndentWidth</span>] = <span class="php-keyword1">array</span>(<span class="php-var">$t</span>, <span class="php-var">$ti</span>++);
<span class="line">326: </span>                <span class="php-var">$t</span> .= <span class="php-quote">' '</span>;
<span class="line">327: </span>            }
<span class="line">328: </span>            <span class="php-var">$this</span>-&gt;tabIndentWidth = <span class="php-var">$tabIndentWidth</span>;
<span class="line">329: </span>        } <span class="php-keyword1">else</span> {
<span class="line">330: </span>            <span class="php-var">$this</span>-&gt;options &amp;= ~self::OPTION_TAB_INDENT;
<span class="line">331: </span>        }
<span class="line">332: </span>
<span class="line">333: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
<span class="line">334: </span>    }
<span class="line">335: </span>
<span class="line">336: </span>    <span class="php-comment">/**
</span><span class="line">337: </span><span class="php-comment">     * Sets the default lexer.
</span><span class="line">338: </span><span class="php-comment">     *
</span><span class="line">339: </span><span class="php-comment">     * @param \FSHL\Lexer $lexer
</span><span class="line">340: </span><span class="php-comment">     * @return \FSHL\Highlighter
</span><span class="line">341: </span><span class="php-comment">     */</span>
<span class="line">342: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> setLexer(Lexer <span class="php-var">$lexer</span>)
<span class="line">343: </span>    {
<span class="line">344: </span>        <span class="php-comment">// Generates the lexer cache on fly, if the lexer cache doesn't exist</span>
<span class="line">345: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;findCache(<span class="php-var">$lexer</span>-&gt;getLanguage())) {
<span class="line">346: </span>            <span class="php-var">$this</span>-&gt;generateCache(<span class="php-var">$lexer</span>);
<span class="line">347: </span>        }
<span class="line">348: </span>
<span class="line">349: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
<span class="line">350: </span>    }
<span class="line">351: </span>
<span class="line">352: </span>    <span class="php-comment">/**
</span><span class="line">353: </span><span class="php-comment">     * Sets the current lexer by name.
</span><span class="line">354: </span><span class="php-comment">     *
</span><span class="line">355: </span><span class="php-comment">     * @param string $lexerName
</span><span class="line">356: </span><span class="php-comment">     * @return \FSHL\Highlighter
</span><span class="line">357: </span><span class="php-comment">     * @throws \InvalidArgumentException If the class for given lexer doesn't exist.
</span><span class="line">358: </span><span class="php-comment">     */</span>
<span class="line">359: </span>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> setLexerByName(<span class="php-var">$lexerName</span>)
<span class="line">360: </span>    {
<span class="line">361: </span>        <span class="php-comment">// Generates the lexer cache on fly, if the lexer cache doesn't exist</span>
<span class="line">362: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;findCache(<span class="php-var">$lexerName</span>)) {
<span class="line">363: </span>            <span class="php-comment">// Finds the lexer</span>
<span class="line">364: </span>            <span class="php-var">$lexerClass</span> = <span class="php-quote">'FSHL\\Lexer\\'</span> . <span class="php-var">$lexerName</span>;
<span class="line">365: </span>            <span class="php-keyword1">if</span> (!<span class="php-keyword2">class_exists</span>(<span class="php-var">$lexerClass</span>)) {
<span class="line">366: </span>                <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> \InvalidArgumentException(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'The class for &quot;%s&quot; lexer doesn\'t exist'</span>, <span class="php-var">$lexerName</span>));
<span class="line">367: </span>            }
<span class="line">368: </span>            <span class="php-var">$lexer</span> = <span class="php-keyword1">new</span> <span class="php-var">$lexerClass</span>();
<span class="line">369: </span>
<span class="line">370: </span>            <span class="php-comment">// Generates the lexer cache on fly</span>
<span class="line">371: </span>            <span class="php-var">$this</span>-&gt;generateCache(<span class="php-var">$lexer</span>);
<span class="line">372: </span>        }
<span class="line">373: </span>
<span class="line">374: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
<span class="line">375: </span>    }
<span class="line">376: </span>
<span class="line">377: </span>    <span class="php-comment">/**
</span><span class="line">378: </span><span class="php-comment">     * Tries to find the lexer cache.
</span><span class="line">379: </span><span class="php-comment">     *
</span><span class="line">380: </span><span class="php-comment">     * @param string $lexerName
</span><span class="line">381: </span><span class="php-comment">     * @return boolean
</span><span class="line">382: </span><span class="php-comment">     */</span>
<span class="line">383: </span>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> findCache(<span class="php-var">$lexerName</span>)
<span class="line">384: </span>    {
<span class="line">385: </span>        <span class="php-comment">// Lexer has been used before</span>
<span class="line">386: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;lexers[<span class="php-var">$lexerName</span>])) {
<span class="line">387: </span>            <span class="php-var">$this</span>-&gt;lexer = <span class="php-var">$this</span>-&gt;lexers[<span class="php-var">$lexerName</span>];
<span class="line">388: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<span class="line">389: </span>        }
<span class="line">390: </span>
<span class="line">391: </span>        <span class="php-comment">// Loads lexer cache</span>
<span class="line">392: </span>        <span class="php-var">$lexerCacheClass</span> = <span class="php-quote">'FSHL\\Lexer\\Cache\\'</span> . <span class="php-var">$lexerName</span>;
<span class="line">393: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">class_exists</span>(<span class="php-var">$lexerCacheClass</span>)) {
<span class="line">394: </span>            <span class="php-var">$this</span>-&gt;lexers[<span class="php-var">$lexerName</span>] = <span class="php-keyword1">new</span> <span class="php-var">$lexerCacheClass</span>();
<span class="line">395: </span>            <span class="php-var">$this</span>-&gt;lexer = <span class="php-var">$this</span>-&gt;lexers[<span class="php-var">$lexerName</span>];
<span class="line">396: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<span class="line">397: </span>        }
<span class="line">398: </span>
<span class="line">399: </span>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<span class="line">400: </span>    }
<span class="line">401: </span>
<span class="line">402: </span>    <span class="php-comment">/**
</span><span class="line">403: </span><span class="php-comment">     * Generates the lexer cache on fly.
</span><span class="line">404: </span><span class="php-comment">     *
</span><span class="line">405: </span><span class="php-comment">     * @param \FSHL\Lexer $lexer
</span><span class="line">406: </span><span class="php-comment">     * @return \FSHL\Highlighter
</span><span class="line">407: </span><span class="php-comment">     */</span>
<span class="line">408: </span>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> generateCache(Lexer <span class="php-var">$lexer</span>)
<span class="line">409: </span>    {
<span class="line">410: </span>        <span class="php-var">$generator</span> = <span class="php-keyword1">new</span> Generator(<span class="php-var">$lexer</span>);
<span class="line">411: </span>        <span class="php-keyword1">try</span> {
<span class="line">412: </span>            <span class="php-var">$generator</span>-&gt;saveToCache();
<span class="line">413: </span>        } <span class="php-keyword1">catch</span> (\RuntimeException <span class="php-var">$e</span>) {
<span class="line">414: </span>            <span class="php-var">$file</span> = <span class="php-keyword2">tempnam</span>(<span class="php-keyword2">sys_get_temp_dir</span>(), <span class="php-quote">'fshl'</span>);
<span class="line">415: </span>            <span class="php-keyword2">file_put_contents</span>(<span class="php-var">$file</span>, <span class="php-var">$generator</span>-&gt;getSource());
<span class="line">416: </span>            <span class="php-keyword1">require_once</span> <span class="php-var">$file</span>;
<span class="line">417: </span>            <span class="php-keyword2">unlink</span>(<span class="php-var">$file</span>);
<span class="line">418: </span>        }
<span class="line">419: </span>
<span class="line">420: </span>        <span class="php-var">$lexerName</span> = <span class="php-var">$lexer</span>-&gt;getLanguage();
<span class="line">421: </span>        <span class="php-var">$lexerCacheClass</span> = <span class="php-quote">'FSHL\\Lexer\\Cache\\'</span> . <span class="php-var">$lexerName</span>;
<span class="line">422: </span>        <span class="php-var">$this</span>-&gt;lexers[<span class="php-var">$lexerName</span>] = <span class="php-keyword1">new</span> <span class="php-var">$lexerCacheClass</span>();
<span class="line">423: </span>        <span class="php-var">$this</span>-&gt;lexer = <span class="php-var">$this</span>-&gt;lexers[<span class="php-var">$lexerName</span>];
<span class="line">424: </span>
<span class="line">425: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
<span class="line">426: </span>    }
<span class="line">427: </span>
<span class="line">428: </span>    <span class="php-comment">/**
</span><span class="line">429: </span><span class="php-comment">     * Outputs a word.
</span><span class="line">430: </span><span class="php-comment">     *
</span><span class="line">431: </span><span class="php-comment">     * @param string $part
</span><span class="line">432: </span><span class="php-comment">     * @param string $state
</span><span class="line">433: </span><span class="php-comment">     * @return string
</span><span class="line">434: </span><span class="php-comment">     */</span>
<span class="line">435: </span>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> template(<span class="php-var">$part</span>, <span class="php-var">$state</span>)
<span class="line">436: </span>    {
<span class="line">437: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;lexer-&gt;flags[<span class="php-var">$state</span>] &amp; Generator::STATE_FLAG_KEYWORD) {
<span class="line">438: </span>            <span class="php-var">$normalized</span> = Generator::CASE_SENSITIVE === <span class="php-var">$this</span>-&gt;lexer-&gt;keywords[Generator::KEYWORD_INDEX_CASE_SENSITIVE] ? <span class="php-var">$part</span> : <span class="php-keyword2">strtolower</span>(<span class="php-var">$part</span>);
<span class="line">439: </span>
<span class="line">440: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;lexer-&gt;keywords[Generator::KEYWORD_INDEX_LIST][<span class="php-var">$normalized</span>])) {
<span class="line">441: </span>                <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;output-&gt;keyword(<span class="php-var">$part</span>, <span class="php-var">$this</span>-&gt;lexer-&gt;keywords[Generator::KEYWORD_INDEX_CLASS] . <span class="php-var">$this</span>-&gt;lexer-&gt;keywords[Generator::KEYWORD_INDEX_LIST][<span class="php-var">$normalized</span>]);
<span class="line">442: </span>            }
<span class="line">443: </span>        }
<span class="line">444: </span>
<span class="line">445: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;output-&gt;template(<span class="php-var">$part</span>, <span class="php-var">$this</span>-&gt;lexer-&gt;classes[<span class="php-var">$state</span>]);
<span class="line">446: </span>    }
<span class="line">447: </span>
<span class="line">448: </span>    <span class="php-comment">/**
</span><span class="line">449: </span><span class="php-comment">     * Outputs a line.
</span><span class="line">450: </span><span class="php-comment">     *
</span><span class="line">451: </span><span class="php-comment">     * @param integer $line
</span><span class="line">452: </span><span class="php-comment">     * @param integer $maxLineWidth
</span><span class="line">453: </span><span class="php-comment">     * @return string
</span><span class="line">454: </span><span class="php-comment">     */</span>
<span class="line">455: </span>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> line(<span class="php-var">$line</span>, <span class="php-var">$maxLineWidth</span>)
<span class="line">456: </span>    {
<span class="line">457: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;output-&gt;template(<span class="php-keyword2">str_pad</span>(<span class="php-var">$line</span>, <span class="php-var">$maxLineWidth</span>, <span class="php-quote">' '</span>, STR_PAD_LEFT) . <span class="php-quote">': '</span>, <span class="php-quote">'line'</span>);
<span class="line">458: </span>    }
<span class="line">459: </span>
<span class="line">460: </span>    <span class="php-comment">/**
</span><span class="line">461: </span><span class="php-comment">     * Pushes a state to the context stack.
</span><span class="line">462: </span><span class="php-comment">     *
</span><span class="line">463: </span><span class="php-comment">     * @param string $lexerName
</span><span class="line">464: </span><span class="php-comment">     * @param string $state
</span><span class="line">465: </span><span class="php-comment">     * @return \FSHL\Highlighter
</span><span class="line">466: </span><span class="php-comment">     */</span>
<span class="line">467: </span>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> pushState(<span class="php-var">$lexerName</span>, <span class="php-var">$state</span>)
<span class="line">468: </span>    {
<span class="line">469: </span>        <span class="php-keyword2">array_unshift</span>(<span class="php-var">$this</span>-&gt;stack, <span class="php-keyword1">array</span>(<span class="php-var">$lexerName</span>, <span class="php-var">$state</span>));
<span class="line">470: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>;
<span class="line">471: </span>    }
<span class="line">472: </span>
<span class="line">473: </span>    <span class="php-comment">/**
</span><span class="line">474: </span><span class="php-comment">     * Pops a state from the context stack.
</span><span class="line">475: </span><span class="php-comment">     *
</span><span class="line">476: </span><span class="php-comment">     * @return array|null
</span><span class="line">477: </span><span class="php-comment">     */</span>
<span class="line">478: </span>    <span class="php-keyword1">private</span> <span class="php-keyword1">function</span> popState()
<span class="line">479: </span>    {
<span class="line">480: </span>        <span class="php-keyword1">return</span> <span class="php-keyword2">array_shift</span>(<span class="php-var">$this</span>-&gt;stack);
<span class="line">481: </span>    }
<span class="line">482: </span>}
<span class="line">483: </span>
</pre></body></html>